<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Admin</title>
        <link rel="stylesheet"  type="text/css" href="admin.css"/>
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
    </head>
    <script>
        "use strict";

        let deleteButton;

        const handleResponse = (xhr) => {
          const obj = JSON.parse(xhr.target.response); // turn it bak into an object
          console.log("obj=", obj);
          console.log(obj.length);

          let container = document.querySelector("#expenses");

          for(let i = obj.length -1; i > 0; i--)
          { // //<button class="editButton">Edit</button>
              //<span><button class="deleteButton">Delete</button></span>
              container.innerHTML += `
              <div class="results">
                <span>Item: ${obj[i].item}</span>
                <span>Cost: ${obj[i].cost}</span>
                <span>Type: ${obj[i].type}</span>
                <span>Necessary: ${obj[i].necessary}</span>
                <span><button class="deleteButton" onclick="deleteExpense(${obj[i].index})">Delete</button></span>
                </div>
             `
          }
      };

      const deleteExpHandle = (xhr) => {
        const obj = JSON.parse(xhr.target.response); // turn it bak into an object
          console.log("obj=", obj);
          console.log(obj.length);
      }

        const downloadExpenses = () => {

        const jokesURL ="/random-jokes?limit=10000000000";
        const xhr = new XMLHttpRequest();
        xhr.onload = handleResponse;
        xhr.open("GET", jokesURL);

        //with XHR,, after we open a connection, but before we 'send()' we can set 1 or more HTTP request ehaders
        //this isn't stickly neccessary because "/random-joke" send JSON by defualt
        xhr.setRequestHeader('Accept', 'application/javascript');
        xhr.send();
      };

      const handleDelete = (index) =>{
        console.log("inside");
        let results = document.querySelectorAll(".results");
         console.log("This is length: " + results.length);
        // console.log(index);
        // console.log(Number(index) - 1);
        // console.log(results);
        // //check to see if there is only one element of if the element you 
        // //are deleteing is the last expense added.
         if(results.length === 1 || index > results.length){ results[0].remove();}
         else{results[results.length - index].remove();}
      }

      const deleteExpense = (index) => {
        const xhr = new XMLHttpRequest();
        xhr.onload = handleDelete(index);
        xhr.open("post", "/delete");
        console.log(Number(index));

        xhr.setRequestHeader('Accept','application/javascript');
        xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
        
        const formData = `index=${index}`; 
        xhr.send(formData); 

        return false;
      }

      const handleClear = (e) => {
        document.querySelector("#expenses").innerHTML = "";
      }

      const clearAll = () => {
        const xhr = new XMLHttpRequest();
        xhr.onload = handleClear;
        xhr.open("post", "/clear");

        xhr.setRequestHeader('Accept','application/javascript');
        xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
        
        const formData = `clear=true`; 
        xhr.send(formData); 

        return false;
      }

        const init = () => {
            downloadExpenses();
            document.querySelector("#clear").addEventListener("click", clearAll);
            deleteButton = document.querySelectorAll(".deleteButton");
            console.log(deleteButton.length);
       };
     
       window.onload = init;

    </script>
    <body>
        <ul id ="topnav">
            <li><a href="/index.html">Home</a></li>
            <li><a href="/app.html">App</a></li>
            <li><a href="/add.html">Edit</a></li>
            <li><a href="/admin.html">Admin</a></li>
        </ul>

        <div id="container">
        <h1>Admin</h1>
        <section>
            <div id="expenses"></div>
            <button id="clear">Clear Expense</button>
        </section>
      </div>
    </body>
</html>